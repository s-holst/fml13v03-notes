Firmware and Bootchain
======================

Architecture Overview:
- Dual-Die Package: die0, die1
- Each Die has:
  - 4-core main CPU (RV64)
  - secure boot co-processor SCPU (SiFive E31 RV32) with masked ROM
  - low-power co-processor LPCPU (SiFive E31 RV32)
  - 16M SPI-Flash that contains boot chain until u-boot

At power-on, SCPU starts executing code from masked ROM at `0x58000000`.
Both dies contain the same ROM. It has been dumped [here](EIC770x_rom.bin)
using [eswin_ipc_tool.py](eswin_ipc_tool.py) on the booted system under linux.
An initial analysis of the ROM contents is [here](EIC770x_rom.md).

The SCPU in each die loads binary images from SPI-Flash and executes them.

SPI-Flash dump in linux:
- `mtd_debug read /dev/mtd/by-name/spi2.0 0 16777216 /root/spi2_0.bin` (die 0)
- `mtd_debug read /dev/mtd/by-name/spi3.0 0 16777216 /root/spi3_0.bin` (die 1)

Boot chain format (in SPI-Flash and compiled binaries):
- Eswin propriatory format (magic: ESWB)
- generated by: https://github.com/eswincomputing/Esbd-77serial-nsign
- Multiple payloads identified by offset, size, type
- Eswin's u-boot fork can also burn new images to SPI-Flash (es_bootloader.c).
- Offsets in SPI-Flash are different from compiled bootchain blobs (re-arranged by es_bootloader.c. Offsets there don't match dumped SPI-Flash)
- Separate images for die0 and die1, only die0 has opensbi and u-boot

Extract the sub-images with this [tool](eswb_extract.py).

`bootloader_FML13V03_die0.bin` contents:
```
die0_sec_fw.bin   loads to 0x59000000 (blob)  # inits clocks, early UART, HDMI, shows OSD (most of bin is Framework x DeepComputing logo)
ddr_fw.bin        loads to 0x59000000 (blob)
die0_d2d_init.bin loads to 0x59000000 (blob)
fw_payload.bin    loads to 0x80000000 (opensbi FW_PAYLOAD:uboot)
```

`bootloader_FML13V03_die1.bin` contents:
```
die1_sec_fw.bin   loads to 0x79000000 (blob)
ddr_fw.bin        loads to 0x79000000 (blob)
die1_d2d_init.bin loads to 0x79000000 (blob)
```

SPI2.0 contents:
```
header.magic=0x42575345 header.num_entries=4
  e.version=1 e.offset=327680(50000) e.size=1738 e.sign_type=0 e.key_index=0 e.payload_type=FIRMWARE e.last_flag=0
  e.version=1 e.offset=331776(51000) e.size=708608 e.sign_type=0 e.key_index=0 e.payload_type=DDR e.last_flag=0
  e.version=1 e.offset=1044480(ff000) e.size=743212 e.sign_type=0 e.key_index=0 e.payload_type=D2D e.last_flag=0
  e.version=1 e.offset=1789952(1b5000) e.size=4036040 e.sign_type=0 e.key_index=0 e.payload_type=BOOTLOADER e.last_flag=1
```

SPI3.0 contents:
```
header.magic=0x42575345 header.num_entries=3
  e.version=1 e.offset=327680(50000) e.size=1658 e.sign_type=0 e.key_index=0 e.payload_type=FIRMWARE e.last_flag=0
  e.version=1 e.offset=331776(51000) e.size=708608 e.sign_type=0 e.key_index=0 e.payload_type=DDR e.last_flag=0
  e.version=1 e.offset=1044480(ff000) e.size=734444 e.sign_type=0 e.key_index=0 e.payload_type=D2D e.last_flag=1
```

These payloads are [here](bootspi).


SPI may have reserved regions to save env

Payloads have 256 byte headers. magic: 0xBB455357 with load and link address, etc.

OpenSBI: inits PMU, IRQ, IPI, Timer, Console, comms with STM32 on UART2 for power off / cold/warm reboot

other firmwares (loaded later):

```
eswin-npu@51c00000
e31_core (SiFive E31 core RV32IMAC)
firmware-name = "eic7700_die0_e31_fw";
firmware-name = "eic7700_die1_e31_fw";

dsp_subsys@52280400
firmware-name = "eic7700_dsp_fw";
```


Boot Messages
-------------

```
gpio init!
usb pweren
pll config ok
die_num:2,die_ordinal:0
Firmware version:1.24;disable ECC
Display version:1.0
boot start temperature:31.392C
DDR type:LPDDR5_D2D_X16;Size:16GB,Data Rate:6400MT/s
Panel: 2, hact=2256 vact=1504
DDR self test OK
D2D Firmware Version: 1.48 auto 0
d2d_pmix_init!
T: degree 32.594
d2d_pmix_need_sweep: cur_degree: 32.594 min_degree: 33.790 fitted_min_degree: 23.000
d2d_pmix_need_sweep: sweep_full_smooth: 0
d2d_pmix_need_sweep: sweep_full_smooth: 0
d2d_pmix_need_sweep: sweep_full: 0
d2d_pmix_need_sweep: sweep_full: 0
d2d_pmix_need_sweep: sweep_incr: 0
d2d_pmix_need_sweep: sweep_incr: 0
======== d2d start        0ms        0ms ========
fan_set_pwm: Auto-invert PWM!
======== d2d init        7ms        7ms ========
T: degree 32.594
[Thermal] Cur: 32.594 Target: 23.500 Heat: 50.000 Cool: 60.000
[Thermal] Cur <= Heat, FAN[off] NPU[off]
fan_set_pwm: Auto-invert PWM!
d2d_init: retry cnt 0
d2d_init: Deassert [default subsys] rst 0x80
d2d_init: Aclk full speed
d2d_init: Deassert [prst|cfg] rst
configure_serdes_mode: Interlaken clock from AXI
d2d_init: Serdes features: rtrim[0xf], term[0x6], eq[0x50]
d2d_init: Deassert [raw_pcs|axi] rst
d2d_init: Deassert [tx] rst
d2d_serdes_cpu_run_and_sync: Serdes CPU run success! Both dies confirmed
d2d_pipe_check_and_sync: Pipe TX ready success! Both dies confirmed
d2d_init: Deassert [core] rst
d2d_phy_check_and_sync: PHY status ready success! Both dies confirmed
d2d_spare_tx_fw_adaptation_and_sync: Starting spare TX FW adaptation
d2d_spare_tx_fw_adaptation_and_sync: TX FW adaptation success! Both dies completed
d2d_init: Deassert [rx] rst
d2d_lock_and_sync: Dual die lock success! Local and remote confirmed
d2d_pmix_fix 375, cur_temp 0x122(32.833), pmix data updated
d2d_spare_rx_fw_adaptation_and_sync: Starting spare RX FW adaptation
d2d_spare_rx_fw_adaptation_and_sync: RX FW adaptation success! Both dies completed
d2d_ber_test_and_sync: Local BER test: PASS (total errors: 0x0)
d2d_ber_test_and_sync: Dual die BER test success!
d2d_init: wait for D2D interrupt about RX LOCAL LINKUP INT==1
fan_set_pwm: Auto-invert PWM!
[Thermal] exiting... FAN[on] NPU[off]
======== d2d end     2014ms     2021ms ========
d2d_init: D2D link success, High speed mode!

lmbox lpcpu <- u84: 0x0000000000000000 (GENERIC_NOTIFY)
LPCPU Firmware Version: 2.31
PMIX data auto load successfully, current T 33.790, pmix low T 34.743, fan polarity 1!
d2d_pmix_fix 298, cur_temp 0x129(34.505)
d2d_pmix_fix 298, cur_temp 0x12a(34.743)
d2d_pmix_fix 298, cur_temp 0x128(34.267)
d2d_pmix_fix 298, cur_temp 0x125(33.551)
d2d_pmix_fix 298, cur_temp 0x129(34.505)
l
OpenSBI v1.3
   ____                    _____ ____ _____
  / __ \                  / ____|  _ \_   _|
 | |  | |_ __   ___ _ __ | (___ | |_) || |
 | |  | | '_ \ / _ \ '_ \ \___ \|  _ < | |
 | |__| | |_) |  __/ | | |____) | |_) || |_
  \____/| .__/ \___|_| |_|_____/|___/_____|
        | |
        |_|

Platform Name             : ESWIN EIC770X
Platform Features         : none
Platform HART Count       : 8
Platform IPI Device       : aclint-mswi
Platform Timer Device     : aclint-mtimer @ 1000000Hz
Platform Console Device   : uart8250
Platform HSM Device       : ---
Platform PMU Device       : ---
Platform Reboot Device    : eswin_eic770x_reset
Platform Shutdown Device  : eswin_eic770x_reset
Platform Suspend Device   : eswin_eic770x_suspend
Platform CPPC Device      : ---
Firmware Base             : 0x80000000
Firmware Size             : 384 KB
Firmware RW Offset        : 0x40000
Firmware RW Size          : 128 KB
Firmware Heap Offset      : 0x54000
Firmware Heap Size        : 48 KB (total), 3 KB (reserved), 9 KB (used), 36 KB (free)
Firmware Scratch Size     : 4096 B (total), 736 B (used), 3360 B (free)
Runtime SBI Version       : 1.0

Domain0 Name              : root
Domain0 Boot HART         : 1
Domain0 HARTs             : 0*,1*,2*,3*,4*,5*,6*,7*
Domain0 Region00          : 0x0000000002000000-0x000000000200ffff (prot_out 0x18)M: (I,R,W) S/U: ()
Domain0 Region01          : 0x0000000022000000-0x000000002200ffff (prot_out 0x18)M: (I,R,W) S/U: ()
Domain0 Region02          : 0x0000000080000000-0x000000008007ffff (prot_out 0x18)M: (R,X) S/U: ()
Domain0 Region03          : 0x0000000040000000-0x000000007fffffff (prot_out 0x9b)M: (R,W) S/U: (R,W)
Domain0 Region04          : 0x0000000000000000-0x0000000fffffffff (prot_out 0x1f)M: () S/U: (R,W,X)
Domain0 Region05          : 0x0000002000000000-0x0000002fffffffff (prot_out 0x1f)M: () S/U: (R,W,X)
Domain0 Region06          : 0x0000008000000000-0x000000ffffffffff (prot_out 0x9b)M: (R,W) S/U: (R,W)
Domain0 Region07          : 0x0000000000000000-0x000003ffffffffff (prot_out 0x98)M: (I) S/U: ()
Domain0 Next Address      : 0x0000000080200000
Domain0 Next Arg1         : 0x00000000f8000000
Domain0 Next Mode         : S-mode
Domain0 SysReset          : yes
Domain0 SysSuspend        : yes

Boot HART ID              : 1
Boot HART Domain          : root
Boot HART Priv Version    : v1.11
Boot HART Base ISA        : rv64imafdchx
Boot HART ISA Extensions  : none
Boot HART PMP Count       : 8
Boot HART PMP Granularity : 4096
Boot HART PMP Address Bits: 39
Boot HART MHPM Count      : 4
Boot HART MIDELEG         : 0x0000000000000666
Boot HART MEDELEG         : 0x0000000000f00509

Hardware Feature[7C1]: 0x4000
Hardware Feature[7C2]: 0x80
Hardware Feature[7C3]: 0x104095c1be241
Hardware Feature[7C4]: 0x1d3ff
ll

U-Boot 2024.01 (Sep 26 2025 - 03:45:28 +0000)

CPU:   rv64imafdc_zba_zbb
Model: Deepcomputing FML13V03
DRAM:  16 GiB (effective 32 GiB)
llCore:  204 devices, 32 uclasses, devicetree: board
Warning: Device tree includes old 'u-boot,dm-' tags: please fix by 2023.07!
MMC:   sdhci@50450000: 0, sd@50460000: 1
Loading Environment from SPIFlash... drivers/spi/es_spi.c:775-   es_spi_of_to_plat() es_spi spi@51800000: max-frequency=4800000
SF: Detected w25q128fw with page size 256 Bytes, erase size 4 KiB, total 16 MiB
*** Warning - bad CRC, using default environment

PCIE-0: Link up (Gen3-x4, Bus0)
[VO][INFO] display_init:480 Die[0] Eswin UBOOT DRM driver version: v1.0.1
[VO][INFO] display_init:539 Detailed mode clock 235690 kHz, flags[9]
    H: 2256 2304 2336 2536
    V: 1504 1507 1513 1549
bus_format: 100a
[VO][INFO] eswin_dc_init:175 src_width:1920, src_height:1080.
[VO][INFO] eswin_dc_init:176 layer:0 hdisplay:2256, htotal:2536, hsync_st:2304, hsync_end:2336
[VO][INFO] eswin_dc_init:178 vdisplay:1504, vtotal:1549, vsync_st:1507, vsync_end:1513
[VO][INFO] eswin_dc_init:183 need scaler.
[VO][INFO] dw_hdmi_setup:2024 dw_hdmi_setup DVI mode
In:    serial,usbkbd
Out:   serial
Err:   vidconsole,serial
Model: Deepcomputing FML13V03
Success to initialize SPI flash at spi@51800000
Bootspi flash write protection enabled
drivers/spi/es_spi.c:775-   es_spi_of_to_plat() es_spi spi@71800000: max-frequency=4800000
SF: Detected w25q128fw with page size 256 Bytes, erase size 4 KiB, total 16 MiB
Success to initialize SPI flash at spi@71800000
Bootspi flash write protection enabled
[VO][INFO] display_init:480 Die[1] Eswin UBOOT DRM driver version: v1.0.1
[VO][INFO] display_init:518 no display connected!
Cpu volatge no need boost at 1.6 Ghz!
drivers/pinctrl/pinctrl-eic770x.c:1265- eswin_pinctrl_probe() eswin_pinctrl pinctrl@0x51600080: : base 0000000051600080,  183 groups, 183 funcs
Net:   net/eth-uclass.c:454-      eth_initialize() No ethernet found.
drivers/spi/designware_spi.c:260-   dw_spi_of_to_plat() dw_spi spi@50814000: max-frequency=4800000
Working FDT set to edcf9050
--------EEPROM INFO--------
Product full SN: FML13V03-2538-D0320000-00000004
starting USB...
Bus usb1@50490000: Register 2000140 NbrPorts 2
Starting the controller
USB XHCI 1.10
Bus d1_usb0@70480000: drivers/pinctrl/pinctrl-eic770x.c:1265- eswin_pinctrl_probe() eswin_pinctrl pinctrl@0x71600080: : base 0000000071600080,  183 groups, 183 funcs
Register 2000140 NbrPorts 2
Starting the controller
USB XHCI 1.10
Bus d1_usb1@70490000: Register 2000140 NbrPorts 2
Starting the controller
USB XHCI 1.10
scanning bus usb1@50490000 for devices... 4 USB Device(s) found
scanning bus d1_usb0@70480000 for devices... 1 USB Device(s) found
scanning bus d1_usb1@70490000 for devices... 3 USB Device(s) found
       scanning usb for storage devices... 0 Storage Device(s) found
No SATA device found!
Hit any key to stop autoboot:  0 
```


U-Boot Environment
------------------

```
=> printenv
arch=riscv
baudrate=115200
board=FML13V03
board_name=FML13V03
boot_a_script=load ${devtype} ${devnum}:${distro_bootpart} ${scriptaddr} ${prefix}${script}; source ${scriptaddr}
boot_conf_addr_r=0xc0000000
boot_conf_file=/extlinux/extlinux.conf
boot_efi_binary=setenv stdout serial,vidconsole;cls;load ${devtype} ${devnum}:${distro_bootpart} ${kernel_addr_r} efi/boot/bootriscv64.efi; if fdt addr -q ${fdt_addr_r}; then bootefi ${kernel_addr_r} ${fdt_addr_r};else bootefi ${kernel_addr_r} ${fdtcontroladdr};fi
boot_efi_bootmgr=if fdt addr -q ${fdt_addr_r}; then bootefi bootmgr ${fdt_addr_r};else bootefi bootmgr;fi
boot_extlinux=sysboot ${devtype} ${devnum}:${distro_bootpart} any ${scriptaddr} ${prefix}${boot_syslinux_conf}
boot_net_usb_start=usb start
boot_pci_enum=pci enum
boot_prefixes=/ /boot/
boot_script_dhcp=boot.scr.uimg
boot_scripts=boot.scr.uimg boot.scr
boot_syslinux_conf=extlinux/extlinux.conf
boot_targets=usb mmc1 mmc0 nvme
boot_updatedelay=10
bootargs= cpu_no_boost_1_6ghz
bootcmd=if env exists updated; then exit;fi;bootflow scan -b;setenv stdout serial,vidconsole;cls;echo No boot medium found!;
bootcmd_dhcp=devtype=dhcp; run boot_net_usb_start; run boot_pci_enum; if dhcp ${scriptaddr} ${boot_script_dhcp}; then source ${scriptaddr}; fi;setenv efi_fdtfile ${fdtfile}; setenv efi_old_vci ${bootp_vci};setenv efi_old_arch ${bootp_arch};setenv bootp_vci PXEClient:Arch:00027:UNDI:003000;setenv bootp_arch 0x1b;if dhcp ${kernel_addr_r}; then tftpboot ${fdt_addr_r} dtb/${efi_fdtfile};if fdt addr -q ${fdt_addr_r}; then bootefi ${kernel_addr_r} ${fdt_addr_r}; else bootefi ${kernel_addr_r} ${fdtcontroladdr};fi;fi;setenv bootp_vci ${efi_old_vci};setenv bootp_arch ${efi_old_arch};setenv efi_fdtfile;setenv efi_old_arch;setenv efi_old_vci;
bootcmd_mmc0=devnum=0; run mmc_boot
bootdelay=0
cpu=eic770x
distro_bootcmd=setenv nvme_need_init; for target in ${boot_targets}; do run bootcmd_${target}; done
efi_dtb_prefixes=/ /dtb/ /dtb/current/
emmc_dev=0
fdt_addr=edcf9050
fdt_addr_r=0x88000000
fdt_high=0xffffffffffffffff
fdtaddr=edcf9050
fdtcontroladdr=edcf9050
fdtfile=eswin/eic7702-deepcomputing-fml13v03.dtb
gpt_partition=gpt write mmc ${emmc_dev} $partitions
initrd_high=0xffffffffffffffff
kernel_addr_r=0x84000000
kernel_comp_addr_r=0x98300000
kernel_comp_size=0x10000000
load_efi_dtb=load ${devtype} ${devnum}:${distro_bootpart} ${fdt_addr_r} ${prefix}${efi_fdtfile}
loadaddr=0x80200000
mmc_boot=if mmc dev ${devnum}; then devtype=mmc; run scan_dev_for_boot_part; fi
nvme_boot=run boot_pci_enum; run nvme_init; if nvme dev ${devnum}; then devtype=nvme; run scan_dev_for_boot_part; fi
nvme_init=if ${nvme_need_init}; then setenv nvme_need_init false; nvme scan; fi
partitions=name=boot,start=1MiB,size=512MiB,type=${typeid_efi},uuid=${uuid_boot};name=swap,size=4096MiB,type=${typeid_swap},uuid=${uuid_swap};name=root,size=-,type=${typeid_filesystem},uuid=${uuid_root}
preboot=setenv fdt_addr ${fdtcontroladdr};fdt addr ${fdtcontroladdr};boardinfo_print;usb start;sata init;nvme scan
pxefile_addr_r=0x88200000
ramdisk_addr_r=0x88300000
sata_boot=if sata dev ${devnum}; then devtype=sata; run scan_dev_for_boot_part; fi
scan_dev_for_boot=echo Scanning ${devtype} ${devnum}:${distro_bootpart}...; for prefix in ${boot_prefixes}; do run scan_dev_for_extlinux; run scan_dev_for_scripts; done;run scan_dev_for_efi;
scan_dev_for_boot_part=part list ${devtype} ${devnum} -bootable devplist; env exists devplist || setenv devplist 1; for distro_bootpart in ${devplist}; do if fstype ${devtype} ${devnum}:${distro_bootpart} bootfstype; then part uuid ${devtype} ${devnum}:${distro_bootpart} distro_bootpart_uuid ; run scan_dev_for_boot; fi; done; setenv devplist
scan_dev_for_efi=setenv efi_fdtfile ${fdtfile}; for prefix in ${efi_dtb_prefixes}; do if test -e ${devtype} ${devnum}:${distro_bootpart} ${prefix}${efi_fdtfile}; then run load_efi_dtb; fi;done;run boot_efi_bootmgr;if test -e ${devtype} ${devnum}:${distro_bootpart} efi/boot/bootriscv64.efi; then echo Found EFI removable media binary efi/boot/bootriscv64.efi; run boot_efi_binary; echo EFI LOAD FAILED: continuing...; fi; setenv efi_fdtfile
scan_dev_for_extlinux=if test -e ${devtype} ${devnum}:${distro_bootpart} ${prefix}${boot_syslinux_conf}; then echo Found ${prefix}${boot_syslinux_conf}; run boot_extlinux; echo EXTLINUX FAILED: continuing...; fi
scan_dev_for_scripts=for script in ${boot_scripts}; do if test -e ${devtype} ${devnum}:${distro_bootpart} ${prefix}${script}; then echo Found U-Boot script ${prefix}${script}; run boot_a_script; echo SCRIPT FAILED: continuing...; fi; done
scriptaddr=0x88100000
sdupdate=ext4load mmc 1:1 0x90000000 sdupdate.scr;source 0x90000000
splashimage=0xe0000000
splashpos=0,0
stderr=vidconsole,serial
stdin=serial,usbkbd
stdout=vidconsole,serial
typeid_efi=C12A7328-F81F-11D2-BA4B-00A0C93EC93B
typeid_filesystem=0FC63DAF-8483-4772-8E79-3D69D8477DE4
typeid_swap=0657FD6D-A4AB-43C4-84E5-0933C84B4F4F
usb_boot=usb start; if usb dev ${devnum}; then devtype=usb; run scan_dev_for_boot_part; fi
usbupdate=if ext4load usb 0 0x90000000 usbupdate.scr; then echo run usbupdate.scr...;source 0x90000000;exit;fi;
uuid_boot=44b7cb94-f58c-4ba6-bfa4-7d2dce09a3a5
uuid_root=80a5a8e9-c744-491a-93c1-4f4194fd690a
uuid_swap=5ebcaaf0-e098-43b9-beef-1f8deedd135e
vendor=eswin

Environment size: 5270/524284 bytes
```
